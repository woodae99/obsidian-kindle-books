/* Copyright (c) 2025 Amazon.com, Inc. or its affiliates. All Rights Reserved. */
define("KPUtils.min",function(){}),define("modules/utils/Config",["require","exports"],function(a,b){"use strict";function c(){return i}function d(){return j}function e(){var a={};return window.location.search.substring(1).split("&").forEach(function(b){var c=b.split("="),d=c[0],e=c.length>1?decodeURIComponent(c[1]):"";a[d]=e}),a}function f(){return g.serviceName||"KindlePlayer"}b.queryParameters=e();var g=window.KindleGlobal,h=g.srsBaseHref||"https://"+window.location.hostname+"/service/web/",i=h+"reader/",j=h+"content/";b.getAuthenticatedBaseServiceUrl=c,b.getUnauthenticatedBaseServiceUrl=d,b.appConfig={version:g.appStaticVersion,versionForRS:g.appVersionForReadingStreams,deviceCapabilityVersion:g.deviceCapabilityVersion},b.getMetricsProgram=f});var __extends=this&&this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);a.prototype=null===b?Object.create(b):(c.prototype=b.prototype,new c)};define("modules/utils/Errors",["require","exports"],function(a,b){"use strict";!function(a){a[a.GeneralLoggerInvalidPath=101]="GeneralLoggerInvalidPath",a[a.ReaderCreatePositionInvalidType=201]="ReaderCreatePositionInvalidType",a[a.ReaderViewInvalidActionInvoked=202]="ReaderViewInvalidActionInvoked",a[a.ReaderGetBookInfoUnknownFormat=203]="ReaderGetBookInfoUnknownFormat",a[a.ReaderMetadataImplUnknownFormat=204]="ReaderMetadataImplUnknownFormat"}(b.Codes||(b.Codes={}));var c=b.Codes,d=function(a){function b(b){if(a.call(this),this.message=b,this.name="KcrError",void 0===this.stack||""===this.stack)try{throw new Error}catch(c){this.stack=c.stack}}return __extends(b,a),b.prototype.setErrorCode=function(a){return this.errorCode=a,this},b.prototype.setCausedBy=function(a){return this.causedBy=a,this},b.prototype.toString=function(){return this.name+": "+(this.errorCode?"("+this.errorCode+" "+c[this.errorCode]+") ":"")+(this.message||"")},b}(Error);b.KcrError=d;var e=function(a){function b(b,c,d){a.call(this,b),this.message=b,this.url=c,this.status=d,this.name="HttpNetworkError"}return __extends(b,a),b.prototype.toString=function(){return a.prototype.toString.call(this)+" (URL="+this.url+"; HTTP status="+this.status+")"},b}(d);b.HttpNetworkError=e;var f=function(a){function b(b,c,d,e,f){a.call(this,b),this.message=b,this.url=c,this.jqXHR=d,this.textStatus=e,this.thrownError=f,this.name="JQueryAjaxError"}return __extends(b,a),b.prototype.toString=function(){return a.prototype.toString.call(this)+" (URL="+this.url+"; AJAX status="+this.textStatus+"; HTTP status="+this.jqXHR.status+"; HTTP error="+this.thrownError+")"},b}(d);b.JQueryAjaxError=f;var g=function(a){function b(b,c){a.call(this,b),this.message=b,this.rjsError=c,this.name="RequireJSError"}return __extends(b,a),b.prototype.toString=function(){var b=this.rjsError.requireModules&&this.rjsError.requireModules[0];return a.prototype.toString.call(this)+" (moduleName="+b+")"},b}(d);b.RequireJSError=g}),define("modules/utils/DeviceUtils",["require","exports","modules/utils/Errors"],function(a,b,c){"use strict";function d(){return-1!==M.indexOf("iPad")}function e(){return-1!==M.indexOf("iPhone")||-1!==M.indexOf("iPod")}function f(){return d()||e()}function g(){return!!M.match(/iPad;.*CPU.*OS 7_\d/i)}function h(){return!!M.match(/Android/i)}function i(){var a=!(!L.vendor||!L.vendor.match(/Amazon/i)),b=!(!M||!M.match(/KF[A-Z]{2}(WI|WA)/i));return h()&&(a||b)}function j(){return d()?"touchend":"click"}function k(){var a;if(f()?a=/OS\s(\d+)/i:h()&&(a=/Android\s(\d+(?:\.\d+)+)/i),a){var b=a.exec(M);if(b&&b.length>1)return parseInt(b[1],10)}throw new c.KcrError("Cannot get major version for the current user agent")}function l(){return!!M.match(/(Chrome|CriOS)/i)}function m(){return f()&&!q()&&!L.standalone}function n(){return M.indexOf("FB_IAB/FB4A")>=0}function o(){return h()&&(n()||s()||r()||!!window._cordovaNative||!!M.match(/WebView|; wv[;)]/i))}function p(){return m()||o()}function q(){return!!M.match(/Safari/i)}function r(){return!!M.match(/Twitter/i)}function s(){return!!M.match(/WhatsApp/i)}function t(){return window.KindleGlobal.deviceInfo&&window.KindleGlobal.deviceInfo.isDesktop}function u(){return!(f()||h()&&l())}function v(){return m()}function w(){return"ontouchstart"in window||!!L.msMaxTouchPoints}function x(){var a=window.KindleGlobal.deviceInfo;return a.name.toLowerCase().split(" ")[0]+"@"+a.version.split(".")[0]}function y(){return f()?"iOS":h()?"Android":t()?"Desktop":"Other"}function z(){return window.KindleGlobal.deviceInfo.deviceType}function A(){return n()}function B(){return q()&&f()?Math.min(window.innerHeight,$(window).height()):window.innerHeight}function C(){try{return f()&&7===k()}catch(a){return!1}}function D(){return-1!==M.indexOf("MSIE")||-1!==M.indexOf("Trident")}function E(){return-1!==M.indexOf("Firefox")}function F(){return!!M.match("Trident/[78].0")}function G(){return!!M.match("Edge/d+")}function H(){return D()||F()||G()}function I(){return F()}function J(){return D()}function K(){return D()}var L=window.navigator,M=L.userAgent;b.isIOS=f,b.isiPadiOS7=g,b.isAndroid=h,b.isFireOS=i,b.getClickEvent=j,b.getMobileOSMajorVersion=k,b.isChrome=l,b.isWebView=p,b.isSafari=q,b.isTwitter=r,b.isDesktop=t,b.requireDelayOnResize=u,b.shouldHideErrorDialogWhenNavigating=v,b.isTouchDevice=w,b.getBrowserWithMajorVersion=x,b.getDevicePlatform=y,b.getDeviceCategory=z,b.isFBOpenLinkWorkaroundNeeded=A,b.getWindowHeight=B,b.shouldSimulateClickForITunes=C,b.isFirefox=E,b.isMSBrowser=H,b.hasTransparentDivProblem=I,b.hasFullscreenCrashProblem=J,b.hasHammerSwipeClickBothFireProblem=K}),define("modules/utils/QueryParamUtils",["require","exports"],function(a,b){"use strict";function c(a){var b=new RegExp("[\\?&]"+a+"=([^&#]*)"),c=b.exec(location.search);return null===c?void 0:decodeURIComponent(c[1].replace(/\+/g," "))}function d(a,b){return b?a+(a.indexOf("?")<0?"?":"&")+b:a}function e(a,b){if(!b)return a;var c="";for(var d in b)c+=d+"="+b[d]+"&";return c.slice(0,-1),a+(a.indexOf("?")<0?"?":"&")+c}function f(a,b){var c=a.split("#",2),d=c[1],e=c[0].split("?",2),f=e[0],g=e[1]||"",h={};g.split("&").forEach(function(a){var b=a.split("=",2);2!==b.length||b[0]in h||(h[b[0]]=b[1])});var i;for(i in b){var j=b[i];null!==j&&void 0!==j?h[i]=b[i]:h[i]&&delete h[i]}g="";var k="?";for(i in h)g+=k+i+"="+h[i],k="&";return f+g+(d?"#"+d:"")}function g(a){return d(a,"sId="+window.KindleGlobal.requestInfo.sId)}b.getQueryParameter=c,b.appendQueryParams=d,b.appendQueryParamsMap=e,b.updateQueryParams=f,b.setSessionIdQueryParam=g}),define("modules/utils/RefTag",["require","exports","modules/utils/QueryParamUtils"],function(a,b,c){"use strict";function d(a){var c=window.KindleGlobal.requestInfo&&window.KindleGlobal.requestInfo.refTag;return c||(a?a+g():b.Constants.NO_REFTAG)}function e(a){return f(d(a))}function f(a){return j+"="+a}function g(){switch(window.KindleGlobal.error){case"UNSUPPORTED_BROWSER":return"_ub";case"GEO_LOCATION_NOT_ALLOWED":case"CONTENT_NOT_ALLOWED":return"_ip";case"CONTENT_NOT_SUPPORTED":return"_uc";default:return""}}function h(a){return window.KindleGlobal.endpointRefTag&&a?window.KindleGlobal.endpointRefTag+a:null}function i(a){var b=d();if(!a||a===b){var e={};e[j]=void 0;var f=c.updateQueryParams(window.location.href,e);window.history.replaceState(f,"",f)}}b.Constants={GET_APP_READER_FOOTER_SUFFIX:"_gka_rf",NO_REFTAG:"k4w_no_ref",RIK_SUFFIX:"_rik",BUY_ACTION_ON_READER_HEADER_SUFFIX:"_store_rh",VIEW_DETAILS_ON_READER_HEADER_SUFFIX:"_details_rh",BUY_ACTION_ON_LANDING_PAGE_SUFFIX:"_store_lp",BUY_ACTION_ON_END_ACTION_SUFFIX:"_store_ea",VIEW_DETAILS_ON_LANDING_PAGE_SUFFIX:"_dp_lp",VIEW_DETAILS_ON_END_ACTION_SUFFIX:"_dp_ea",GET_APP_END_ACTION_SUFFIX:"_gka_ea",TEXT_ME_SUFFIX:"_text_me",RIK_DESKTOP_SUFFIX:"_rik_desktop",VIEW_DETAILS_ON_ERROR_DIALOG:"_details_error",K4W_KA_NOTEBOOK:"k4w_ka_notebook"};var j="ref_";b.getRefTag=d,b.getRefTagQueryParam=e,b.formatRefTagForQS=f,b.formatError=g,b.getEndpointRefTag=h,b.removeRefTagFromUrl=i}),define("modules/metrics/ReadingStreams",["require","exports"],function(a,b){"use strict";function c(){return d||(d=new h),d}var d,e="Unknown",f=function(){function a(){}return a.OpenContext="OpenContext",a.ShowContext="ShowContext",a.HideContext="HideContext",a.OpenContent="OpenContent",a.Action="Action",a.ContentAction="ContentAction",a.ConsumeContentSpan="ConsumeContentSpan",a.ConsumeContentPoint="ConsumeContentPoint",a.AuxContentState="AuxContentState",a.Metadata="Metadata",a.SettingState="SettingState",a}();b.EventTypes=f;var g=function(){function a(){}return a.CONTEXT_KP="KindlePlayerClient",a.CONTEXT_KSHARE="KShare",a.CONTEXT_KSHARE_LANDING_PAGE_LOADED="KShareLandingPageLoaded",a.CONTEXT_KSHARE_LANDING_PAGE="KShareLandingPage",a.CONTEXT_KSHARE_END_ACTION="KShareEndAction",a.CONTEXT_COVER_PAGE="CoverPage",a.CONTEXT_READER="Reader",a.CONTEXT_PRE_AUTH="KSharePreAuth",a.CONTEXT_POST_AUTH="KSharePostAuth",a.CONTEXT_RIK_INTERSTITIAL="KShareRikInterstitial",a.CONTEXT_RIK_DESKTOP="RIKDesktop",a.CONTEXT_TEXT_ME="TextMe",a.CONTEXT_UNSUPPORTED_BROWSER="UnsupportedBrowser",a.CONTEXT_SHARING_DIALOG="SharingDialog",a.CONTEXT_ERROR_DIALOG="ErrorDialog",a.CONTEXT_PAGE_LOADED="KindlePlayerPageLoaded",a.CONTEXT_PDOC_SHARE_PAGE="PDocQuoteSharePage",a.ERROR_DP_URL_NOT_CONFIGURED="DetailPageUrlNotConfigured",a.ACTION_SCROLL="Scroll",a.ACTION_END_ACTION_BACK_BUTTON_CLICKED="BackClicked",a.ACTION_LEARN_MORE_CLICKED="LearnMoreClicked",a.ACTION_VIEW_FULL_DETAILS_CLICKED="ViewFullDetailsClicked",a.ACTION_NAVIGATION_ATTEMPT_PAST_BOOK_END="NavigationAttemptPastBookEnd",a.ACTION_CLOSE_BUTTON_CLICKED="CloseClicked",a.ACTION_OVERLAY_CLICKED="OverlayClicked",a.ACTION_PREVIEW_BOOK_BUTTON_CLICKED="PreviewBookClicked",a.ACTION_LANDING_PAGE_SWIPE_LEFT="LandingPageSwipeLeft",a.ACTION_END_ACTION_SWIPE_RIGHT="EndActionSwipeRight",a.ACTION_LEFT_ARROW_PRESSED="KeyPressed = =LeftArrow",a.ACTION_RIGHT_ARROW_PRESSED="KeyPressed = =RightArrow",a.ACTION_ESC_PRESSED="KeyPressed = =Escape",a.ACTION_SHARE_CLICKED="ShareClicked",a.ACTION_SHARE_CHANNEL_CLICKED="ShareChannelClicked",a.ACTION_SLIDER_CLICKED="SliderClicked",a.ACTION_SLIDER_DRAGGED="SliderDragged",a.ACTION_SLIDER_DRAGGED_DISTANCE="SliderDragged::Distance",a.ACTION_OPEN_KCR="OpenKCR",a.ACTION_TEXT_ME="TextMe",a.ACTION_WISH_LIST_CLICKED="AddToWishListClicked",a.ACTION_DOWNLOAD_CHROME_CLICKED="DownloadChromeClicked",a.ACTION_DOWNLOAD_FIREFOX_CLICKED="DownloadFirefoxClicked",a.ACTION_DOWNLOAD_IE_CLICKED="DownloadIEClicked",a.ACTION_DOWNLOAD_SAFARI_CLICKED="DownloadSafariClicked",a.ACTION_BUY_BUTTON_CLICKED="BuyClicked",a.ACTION_GET_KINDLE_APP_CLICKED="GetKindleAppClicked",a.ACTION_SHOW_MORE_COLLAPSED_QUOTE="ShowMore = =Collapsed = =Quote",a.ACTION_SHOW_MORE_COLLAPSED_SYNOPSIS="ShowMore = =Collapsed = =Synopsis",a.ACTION_SHOW_MORE_EXPANDED_QUOTE="ShowMore = =Expanded = =Quote",a.ACTION_SHOW_MORE_EXPANDED_SYNOPSIS="ShowMore = =Expanded = =Synopsis",a.ACTION_CONDITIONS_OF_USE_CLICKED="ConditionsOfUseClicked",a.ACTION_PRIVACY_NOTICE_CLICKED="PrivacyNoticeClicked",a.ACTION_LEGAL_NOTICES_CLICKED="LegalNoticesClicked",a.ACTION_LOGOUT_CLICKED="LogoutClicked",a.ACTION_RETRY_CLICKED="RetryClicked",a.CONTEXT_NOTEBOOK_PAGE="NotebookPage",a.CONTEXT_NOTEBOOK_PAGE_EMPTY_LIB="NotebookPageEmptyLib",a.CONTEXT_NOTEBOOK_PAGE_EMPTY_ANNOTATIONS="NotebookPageEmptyAnnotations",a.CONTEXT_ERROR_ALERT="ErrorAlert",a.ACTION_NOTEBOOK_PAGE_ANNOTATIONS_LOAD_FAIL="NotebookPageAnnotationsLoadFail",a.ACTION_NOTEBOOK_PAGE_LIBRARY_LOAD_FAIL="NotebookPageLibraryLoadFail",a.ACTION_NOTEBOOK_SEARCH_SUBMITTED="NotebookSearchSubmitted",a.ACTION_NOTEBOOK_SEARCH_RESULTS_FOUND="NotebookSearchResultsFound",a.ACTION_DETAIL_PAGE_CLICKED="DetailPageUrlClicked",a.ACTION_OPEN_IN_KINDLE_TRIGGER="OpenInKindleTrigger",a.ACTION_OPEN_IN_KINDLE_SUCCESS="OpenInKindleSuccess",a.ACTION_OPEN_IN_KINDLE_FAIL="OpenInKindleFail",a.ACTION_HIGHLIGHT_DELETED="HighlightDeleted",a.ACTION_NOTE_DELETED="NoteDeleted",a.ACTION_NOTE_ADDED="NoteAdded",a.ACTION_NOTE_EDITED="NoteEdited",a.ACTION_HIGHLIGHTS_NOTES_COPY="HighlightsNotesCopy",a.ACTION_HIGHLIGHT_TRUNCATED="HighlightTruncated",a.ACTION_HIGHLIGHT_HIDDEN="HighlightHidden",a.ACTION_HIGHLIGHT_EMPTY_TEXT="HighlightEmptyText",a}();b.RSConstants=g;var h=function(){function a(){this.events=[],this.CONTEXT_CHANGE_IMMERSIVE_FOOTER="ReaderFontSizeChangeFooter",this.CONTEXT_CHANGE_IMMERSIVE_HEADER="ReaderChangeImmersiveHeader",this.CONTEXT_READER="Reader",this.CONTEXT_SHARING_DIALOG="SharingDialog",this.CONTEXT_JS_ERROR="JSError",this.ACTION_FONT_SIZE_CHANGE="FontSizeChange",this.ACTION_CONTENT_NOT_RENDERED_IN_TIME="BookContentNotRenderedInTime",this.ACTION_BUY_BUTTON_CLICKED="BuyClicked",this.ACTION_GET_KINDLE_APP_CLICKED="GetKindleAppClicked",this.ACTION_READ_IN_KINDLE_CLICKED="ReadInKindleClicked",this.ACTION_WISH_LIST_CLICKED="AddToWishListClicked",this.ACTION_VIEW_FULL_DETAILS_CLICKED="ViewFullDetailsClicked",this.ACTION_LEARN_MORE_CLICKED="LearnMoreClicked",this.ACTION_CLOSE_CLICKED="CloseClicked",this.ACTION_SHARE_CLICKED="ShareClicked",this.ACTION_SHARE_CHANNEL_CLICKED="ShareChannelClicked",this.SPAN_TYPE_TEXT="Text",this.ERROR_DP_URL_NOT_CONFIGURED="DetailPageUrlNotConfigured",this.UNHANDLED_REJECTION="UnhandledRejection",this.ACTION_SLIDER_CLICKED="SliderClicked",this.ACTION_SLIDER_DRAGGED="SliderDragged",this.ACTION_SLIDER_DRAGGED_DISTANCE="SliderDragged::Distance",this.ACTION_REGION_MAGNIFICATION_ACTIVATE="RegionMagnificationEnabled",this.ACTION_REGION_MAGNIFICATION_DEACTIVATE="RegionMagnificationDisabled",this.ACTION_REGION_MAGNIFICATION_FORWARD="RegionMagnificationForward",this.ACTION_REGION_MAGNIFICATION_BACKWARD="RegionMagnificationBackward"}return a.prototype.getEvents=function(){return this.events.slice(0)},a.prototype.clearEvents=function(a){var b=this.events;b.splice(0,a&&a<b.length?a:b.length)},a.prototype.addEvent=function(a){a.metadataMap.requestId=a.metadataMap.requestId||window.KindleGlobal.requestInfo.requestId,this.events.push(a)},a.prototype.consumeContentPoint=function(a,b,c,d,g){void 0===d&&(d={}),this.addEvent({type:f.ConsumeContentPoint,timestamp:g||Date.now(),context:a||e,pointType:b,position:Math.max(c||0,0),metadataMap:d})},a.prototype.consumeContentSpan=function(a,b,c,d,g,h){void 0===g&&(g={}),this.addEvent({type:f.ConsumeContentSpan,context:a||e,timestamp:h||Date.now(),spanType:b,startPosition:c,endPosition:d,metadataMap:g})},a.prototype.hideContext=function(a,b,c){void 0===b&&(b={}),this.addEvent({type:f.HideContext,context:a||e,timestamp:c||Date.now(),metadataMap:b})},a.prototype.openContent=function(a,b,c,d,e,g,h,i){void 0===h&&(h={}),this.addEvent({type:f.OpenContent,contentType:a,timestamp:i||Date.now(),asin:c,embeddedId:b,srl:d,erl:e,bookLength:g,metadataMap:h})},a.prototype.openContext=function(a,b,c,d){void 0===c&&(c={}),this.addEvent({type:f.OpenContext,openerContext:a||e,openedContext:b||e,timestamp:d||Date.now(),metadataMap:c})},a.prototype.performAction=function(a,b,c,d){void 0===c&&(c={}),this.addEvent({type:f.Action,context:a||e,actionId:b,timestamp:d||Date.now(),metadataMap:c})},a.prototype.performContentAction=function(a,b,c,d,g,h){void 0===g&&(g={}),this.addEvent({type:f.ContentAction,context:a||e,actionId:b,startPosition:c,endPosition:d,timestamp:h||Date.now(),metadataMap:g})},a.prototype.recordAuxContentState=function(a,b,c,d,e,g,h){void 0===g&&(g={}),this.addEvent({type:f.AuxContentState,auxContentType:a,supportsMainContent:b,hasData:c,isEnabled:d,supportsNoData:e,timestamp:h||Date.now(),metadataMap:g})},a.prototype.recordMetadata=function(a,b,c){this.addEvent({type:f.Metadata,context:a||e,timestamp:c||Date.now(),metadataMap:b})},a.prototype.recordSetting=function(a,b,c,d,g,h){void 0===g&&(g={}),this.addEvent({type:f.SettingState,context:a||e,settingId:b,state:c,isChange:d,timestamp:h||Date.now(),metadataMap:g})},a.prototype.showContext=function(a,b,c){void 0===b&&(b={}),this.addEvent({type:f.ShowContext,context:a||e,timestamp:c||Date.now(),metadataMap:b})},a}();b.Manager=h,b.getManager=c}),define("modules/utils/StringUtils",["require","exports"],function(a,b){"use strict";function c(a,b,c){return a.replace(h,function(e,f){var g=b[f];if(void 0===b[f])throw new Error("Couldn't find value for key '"+f+"' in template '"+a+"'.");return c?d(g):g})}function d(a){var b=document.createElement("div");return b.appendChild(document.createTextNode(a)),b.innerHTML}function e(a){return $("<div/>").html(a).text()}function f(a){var b=new RegExp("\r\n","g"),c=new RegExp("\n","g");return d(a).replace(b,"<br/>").replace(c,"<br/>")}function g(a){var b=new RegExp("<br\\s*\\/?>","g");return e(a.replace(b,"\n"))}var h=/\${([\w_]+)}/g;b.format=c,b.escapeHTML=d,b.unescapeHTML=e,b.escapeAndFormatHTML=f,b.unescapeAndFormatHTML=g}),define("modules/utils/Utility",["require","exports","modules/utils/DeviceUtils","modules/metrics/MetricsUtils","modules/utils/QueryParamUtils","modules/metrics/ReadingStreams","modules/utils/RefTag","modules/utils/StringUtils"],function(a,b,c,d,e,f,g,h){"use strict";function i(a,b){var c=window;c.Kindle=c.Kindle||{},c.Kindle[a]=b}function j(){return window.KindleGlobal.requestInfo&&window.KindleGlobal.requestInfo.associateTag}function k(){var a=j();return a?"tag="+a:null}function l(){return window.KindleGlobal&&window.KindleGlobal.requestInfo?window.KindleGlobal.requestInfo.embedPreviewMode:void 0}function m(a,b){var c=g.getEndpointRefTag(b);a=e.appendQueryParams(a,g.getRefTagQueryParam(c));var d=k();d&&(a=e.appendQueryParams(a,d));var f=window.KindleGlobal.requestInfo;return f.linkCode&&(a=e.appendQueryParams(a,"linkCode="+f.linkCode)),f.linkType&&(a=e.appendQueryParams(a,"linkType="+f.linkType)),f.linkId&&(a=e.appendQueryParams(a,"linkId="+f.linkId)),a}function n(a){return h.format(window.KindleGlobal.readUrlTemplate,{path:a||""})}function o(a,b){var d=g.getRefTag(b),f=g.formatRefTagForQS(d);if(c.isIOS())f="ct="+d;else if(c.isAndroid()){var h=g.formatRefTagForQS(d),i=k();i&&(h+="&"+i),f="referrer="+encodeURIComponent("utm_source=kindle_player&utm_content="+encodeURIComponent(window.btoa(h)))}return e.appendQueryParams(a,f)}function p(a){$("<a>",{href:a})[0].click()}function q(a,b,c){function d(){var a=$(this).is(":hidden")?this.naturalHeight:$(this).height(),d=$(this).is(":hidden")?this.naturalWidth:$(this).width();x>a&&x>d?c&&c(this):b&&b(this)}a.load(d).each(function(){this.complete&&$(this).load()})}function r(a,b){window.open(a,"_blank",b||"")}function s(a,b,c){void 0===b&&(b=y);var d,e,f=!1;return function(){var g=c||this,h=Date.now();f||d&&!(h>=d+b)||(f=!0,a.apply(g,arguments),clearTimeout(e),e=setTimeout(function(){d=h,f=!1},b))}}function t(a,b,c){void 0===b&&(b=y);var d;return function(){var e=c||this,f=Date.now();(!d||f>=d+b)&&a.apply(e,arguments),d=f}}function u(){var a=window.location;return a.origin||a.protocol+"//"+a.hostname+(a.port?":"+a.port:"")}function v(){var a=window.location.search;return!!a&&-1!==a.indexOf("from=Bookcard")}function w(a,b,c){!function(e){var g=f.getManager();if(!e)return void d.recordAction(c,g.ERROR_DP_URL_NOT_CONFIGURED);d.recordAction(c,g.ACTION_VIEW_FULL_DETAILS_CLICKED);var h=m(e,b);a?r(h):window.open(h,"_self","")}(window.KindleGlobal.bookDetailPageUrl)}var x=5,y=200;b.addToGlobalKindle=i,b.getAssociateTag=j,b.getEmbedPreviewMode=l,b.getAmazonAttributedUrl=m,b.getReadUrl=n,b.getAppStoreUrlWithRefTag=o,b.simulateClickForLink=p,b.checkImageLoaded=q,b.openInNewWindow=r,b.throttled=s,b.debounced=t,b.getOrigin=u,b.isFromBookCard=v,b.openBookDetails=w}),define("modules/metrics/PMET",["require","exports","modules/utils/Config","modules/utils/DeviceUtils","modules/utils/RefTag","modules/utils/Utility"],function(a,b,c,d,e,f){"use strict";function g(a){return a&&a.match(v)?a.replace(w,""):a}function h(){var a={};return a[u.Version]=c.appConfig.version,a[u.Browser]=d.getBrowserWithMajorVersion(),a[u.RefTag]=g(e.getRefTag()),a[u.AssociateTag]=f.getAssociateTag(),a[u.EmbedPreviewMode]=f.getEmbedPreviewMode(),a}function i(){return window.performance.now()}function j(){return A.slice(0)}function k(a){A.splice(0,a&&a<A.length?a:A.length)}function l(a,b){return void 0===b&&(b=!1),B[a]=new z(a,b),B[a]}function m(){for(var a=[],b=0;b<arguments.length;b++)a[b-0]=arguments[b];a.forEach(function(a){console.debug("Recorded metric:",JSON.stringify(a)),A.push(a),delete B[a.name]})}function n(a){return B[a]}function o(){C=i(),setTimeout(q,D)}function p(){return i()-C>E}function q(){if(p()){var a=0;for(var c in B){var d=B[c];a+=d.mainTimer.discardRunningTimers();for(var e in d.timers){a+=d.timers[e].discardRunningTimers()}}m(l(b.Constants.SUSPEND_DETECTED));var d=l(b.Constants.DISCARDED_METRIC_TIMERS_AFTER_SUSPEND);d.mainCounter.increment(a+t),m(d),t=0,console.warn("Client exceeded suspend time threshold; discarded %d running metric timer(s)",a)}o()}function r(a){C=a}window.performance=window.performance||{},window.performance.now=window.performance.now||Date.now,b.Constants={BOOK_CONTENT_RENDERED:"BookContentRendered",LOCAL_CONTENT:"LocalContent",REMOTE_CONTENT:"RemoteContent",QUARTILE_STARTED:"QuartileStarted",SUSPEND_DETECTED:"SuspendDetected",DISCARDED_METRIC_TIMERS_AFTER_SUSPEND:"DiscardedMetricTimersAfterSuspend",NOTEBOOK_PAGE_LOADED:"NotebookPageLoaded",NOTEBOOK_PAGE_LIBRARY_LOADED:"NotebookPageLibraryLoaded",NOTEBOOK_PAGE_ANNOTATIONS_LOADED:"NotebookPageAnnotationsLoaded"};var s="::",t=0,u={OS:"OS",Browser:"Browser",Version:"Version",RefTag:"RefTag",AssociateTag:"AssociateTag",EmbedPreviewMode:"EmbedPreviewMode"},v=/^(cm_sw|k4w_oembed)/i,w=/_[^_]+$/i;b.getBreakdownMap=h;var x=function(){function a(a,b){void 0===b&&(b=0),this.name=a,this.count=b,this.count=b,this.breakdown=[]}return a.prototype.increment=function(a){return void 0===a&&(a=1),this.count+=a,this},a}();b.Counter=x;var y=function(){function a(a){this.name=a,this.time=0,this.count=0,this.started=[],this.breakdown=[]}return a.prototype.start=function(){return this.started.push(i()),this},a.prototype.stop=function(){return this.started.length>0?p()?(this.started.pop(),t++,console.warn("Discarded a running timer in Timer.stop() because client suspend was detected")):(this.time+=i()-this.started.pop(),this.count++):console.warn("Extra StopTimer called for timer: "+this.name),this},a.prototype.startTimer=function(){return this.start(),this},a.prototype.stopTimer=function(){return this.stop(),this},a.prototype.discardRunningTimers=function(){var a=this.started.length;return this.started=[],a},a.prototype.setTime=function(a){return this.time=a,this},a}();b.Timer=y;var z=function(){function a(a,b){void 0===b&&(b=!1),this.name=a,this.reportedName=a,this.counters={},this.timers={},this.breakdown=[],this.properties={},this.mainTimer=new y(this.name),b&&this.mainTimer.start(),this.mainCounter=new x(this.name)}return a.prototype.getSubTimer=function(a){return this.timers[a]=this.timers[a]||new y(a),this.timers[a]},a.prototype.getSubCounter=function(a){return this.counters[a]=this.counters[a]||new x(a),this.counters[a]},a.prototype.incrementSubCounter=function(a,b){return void 0===b&&(b=1),this.getSubCounter(a).increment(b),this},a.prototype.increment=function(){return this.mainCounter.increment(),this},a.prototype.startTimer=function(){return this.mainTimer.start(),this},a.prototype.stopTimer=function(){return this.mainTimer.stop(),this},a.prototype.appendToReportedName=function(){for(var a=[],b=0;b<arguments.length;b++)a[b-0]=arguments[b];return this.reportedName+=s+a.join(s),this},a.prototype.setProperty=function(a,b){return this.properties[a]=b,this},a}();b.Metric=z;var A=[],B={};b.getNow=i,b.getMetrics=j,b.clearMetrics=k,b.createMetric=l,b.record=m,b.getMetric=n;var C,D=5e3,E=2e4;b.isSuspendDetected=p,b.checkForSuspend=q,b.setLastSuspendCheckTime=r,o()}),define("modules/errors/JqueryPromiseErrorHandler",["require","exports"],function(a,b){"use strict";function c(a){throw"object"!=typeof a?(alert("JQueryPromiseErrorHandler was passed a non-object error argument! Please review your code: we should always pass/throw a new Error() object in order to get the best possible call stacks in our metrics."),new Error(a)):null===a?new Error("JQuery Promise rejection"):a}b.onPromiseRejected=c}),define("modules/utils/Service",["require","exports","modules/metrics/PMET","q","modules/utils/Config","modules/utils/Errors","jquery"],function(a,b,c,d,e,f,g){"use strict";function h(a){return j({url:a,dataType:"text json",converters:{"text json":function(a){var b=a.trim().replace(/\u2028/g,"\\u2028").replace(/\u2029/g,"\\u2029").replace(/^.+?\((.+)\);$/,"$1");return g.parseJSON(b)}},timeout:3e4})}function i(a,b,d,e,f){function h(a){console.debug("Ajax succeeded after retry."),b(a),c.record(c.createMetric("AjaxSuccessAfterRetry"))}function i(b){return function(e,j,k){return 0>=b?(d(e,j,k),void c.record(c.createMetric("AjaxErrorAfterRetry"))):void setTimeout(function(){console.debug("Retrying ajax request ("+b+" remaining)..."),g.ajax(a).done().then(h,i(b-1))},f)}}void 0===e&&(e=3),void 0===f&&(f=3e3),g.ajax(a).done().then(b,i(e))}function j(a){function b(a){e.resolve(a)}function c(b,c,d){e.reject(new f.JQueryAjaxError(a.serviceCall||"JQuery ajax error",a.url,b,c,d))}var e=d.defer();return i(a,b,c),e.promise}function k(a){var b={url:a.url,serviceCall:a.serviceCall,dataType:"json"};return b.beforeSend=function(a){return a.setRequestHeader("Amzn-Device-Type",r),!0},a.postData&&(b.type="POST",b.contentType="application/json",b.processData=!1,b.data=JSON.stringify(a.postData)),void 0!==a.async&&(b.async=a.async),j(b)}function l(a){var b={url:a.url,serviceCall:a.serviceCall,dataType:"json"},c=window.KindleGlobal.srsDeviceToken;return b.beforeSend=function(a){return a.setRequestHeader("Amzn-Device-Type",r),a.setRequestHeader("X-ADP-Session-Token",c),!0},a.postData&&(b.type="POST",b.contentType="application/json",b.processData=!1,b.data=JSON.stringify(a.postData)),void 0!==a.async&&(b.async=a.async),j(b)}function m(a){function b(){var b=a.useAuthenticated?s:t;return b+="startReading?asin="+a.asin,a.kindleSessionId&&(b+="&kindleSessionId="+a.kindleSessionId),a.contentVersion&&(b+="&contentVersion="+a.contentVersion),a.formatVersion&&(b+="&formatVersion="+a.formatVersion),void 0!==a.isSample&&(b+="&isSample="+(a.isSample?"true":"false")),window.KindleGlobal.capabilities.ALLOW_FULL_BOOK&&(b+="&checkSubscription=true"),b+=u,encodeURI(b)}return a.useAuthenticated?l({url:b(),serviceCall:"startReading"}):k({url:b(),serviceCall:"startReading"})}function n(a){function b(){var b=a.useAuthenticated?s:t;return b+="getFileUrl?asin="+a.asin,a.kindleSessionId&&(b+="&kindleSessionId="+a.kindleSessionId),a.contentVersion&&(b+="&contentVersion="+a.contentVersion),a.formatVersion&&(b+="&formatVersion="+a.formatVersion),void 0!==a.isSample&&(b+="&isSample="+(a.isSample?"true":"false")),a.skeletonIds&&(b+="&skeletonIds="+a.skeletonIds.join(",")),a.fragmentIds&&(b+="&fragmentIds="+a.fragmentIds.join(",")),a.glyphIds&&(b+="&glyphIds="+a.glyphIds.join(",")),a.resourceIds&&(b+="&resourceIds="+a.resourceIds.join(",")),a.locationMapIds&&(b+="&locationMapIds="+a.locationMapIds.join(",")),window.KindleGlobal.capabilities.ALLOW_FULL_BOOK&&(b+="&checkSubscription=true"),encodeURI(b)}return a.useAuthenticated?l({url:b(),serviceCall:"getFileUrl"}):k({url:b(),serviceCall:"getFileUrl"})}function o(a){function b(){var b=s;return b+="stillReading?asin="+a.asin,a.guid&&(b+="&guid="+encodeURIComponent(a.guid)),a.kindleSessionId&&(b+="&kindleSessionId="+a.kindleSessionId),a.lastPageRead&&(b+="&lastPageRead="+a.lastPageRead),a.localTimeOffset&&(b+="&localTimeOffset="+a.localTimeOffset),a.positionType&&(b+="&positionType="+encodeURIComponent(a.positionType)),window.KindleGlobal.capabilities.ALLOW_FULL_BOOK&&(b+="&checkSubscription=true"),b}return l({url:b(),serviceCall:"stillReading"})}function p(a){function b(){var b=s;return b+="doneReading?asin="+a.asin,a.guid&&(b+="&guid="+encodeURIComponent(a.guid)),a.kindleSessionId&&(b+="&kindleSessionId="+a.kindleSessionId),a.lastPageRead&&(b+="&lastPageRead="+a.lastPageRead),a.localTimeOffset&&(b+="&localTimeOffset="+a.localTimeOffset),a.positionType&&(b+="&positionType="+encodeURIComponent(a.positionType)),window.KindleGlobal.capabilities.ALLOW_FULL_BOOK&&(b+="&checkSubscription=true"),b}return l({url:b(),serviceCall:"doneReading"})}function q(b,c,d,e,g){function h(c){var i=c.requireModules,j=new Array;i.forEach(function(a){if(v.hasOwnProperty(a)||(v[a]=d),0>=v[a])throw g&&g(c),new f.RequireJSError("Failed to require library '"+a+"' using RequireJS.",c);requirejs.undef(a),v[a]--,j.push(a)}),setTimeout(function(){console.debug("Retrying RequireJS requests..."),a(b,null,h)},e)}void 0===d&&(d=3),void 0===e&&(e=3e3),a(b,c,h)}var r=window.KindleGlobal.amazonDeviceType,s=e.getAuthenticatedBaseServiceUrl(),t=e.getUnauthenticatedBaseServiceUrl(),u="&clientVersion="+e.appConfig.deviceCapabilityVersion;b.qJsonpUsingAjax=h,b.qAjax=j,b.ajaxUnauthenticated=k,b.ajaxAuthenticated=l,b.startReading=m,b.getFileUrl=n,b.stillReading=o,b.doneReading=p;var v={};b.requireWithRetry=q}),define("modules/utils/ReaderViewLoader",["require","exports","modules/utils/Service"],function(a,b,c){"use strict";function d(a){c.requireWithRetry(["KindlePlayerLoader"],function(){c.requireWithRetry(["KindlePlayer"],function(b){a(b)})})}b.whenReaderReady=d}),define("modules/metrics/MetricsUtils",["require","exports","./PMET","./ReadingStreams","modules/errors/JqueryPromiseErrorHandler","modules/utils/Service","modules/utils/ReaderViewLoader"],function(a,b,c,d,e,f,g){"use strict";function h(a,b,e,f){void 0===e&&(e={}),void 0===f&&(f=null),c.record(c.createMetric(b).appendToReportedName(a)),d.getManager().performAction(a,b,e,f)}function i(a,b){void 0===b&&(b={}),c.record(c.createMetric("Viewed").appendToReportedName(a)),d.getManager().showContext(a,b)}function j(a){t=a}function k(){return t}function l(){return!u||"pending"!==u.state()&&"resolved"!==u.state()?(u=$.Deferred(),g.whenReaderReady(function(){f.requireWithRetry(["modules/metrics/ReadingStreams","modules/metrics/PMET","modules/metrics/MetricsUtils"],function(a,b,c){a&&a.getManager?u.resolve(a.getManager(),b,c):u.reject(new Error("Metrics Managers not properly loaded"))})}),u.promise()):u.promise()}function m(){return v?v.promise():(v=$.Deferred(),$(document).ready(function(){g.whenReaderReady(function(){f.requireWithRetry(["modules/metrics/UploadManager"],function(a){a.init(),v.resolve(a)})})}),v.promise())}function n(a,b){var c=$.Deferred();return h(a,b),m().then(function(a){a.uploadMetrics(!0),c.resolve()}),c.promise()}function o(a,b,c){l().then(function(d,e){d.showContext(a,b||{},c);var f=e.createMetric("Viewed").appendToReportedName(a);w[f.reportedName]||(e.record(f),w[f.reportedName]=1)},e.onPromiseRejected)}function p(a,b,c){l().then(function(d){d.hideContext(a,b||{},c)},e.onPromiseRejected)}function q(a,b){var c=$.Deferred();return l().always(function(d,e){var f=e.createMetric(a);b&&f.appendToReportedName(b),e.record(f),c.resolve()}),c.promise()}function r(a,b,c){l().then(function(d,e){"string"==typeof a&&(a=e.createMetric(a)),e.record(a),b.name=a.reportedName,d.recordMetadata(c,b)},e.onPromiseRejected)}function s(){return{timezoneOffset:(new Date).getTimezoneOffset()}}var t,u,v,w={};b.recordAction=h,b.recordViewShown=i,b.setCurrentContainerView=j,b.getCurrentContainerView=k,b.getManagers=l,b.recordActionAndUploadMetrics=n,b.recordShowContext=o,b.recordHideContext=p,b.recordPMET=q,b.recordPMETAndRSMetadata=r,b.getInitialRSMetadata=s}),define("modules/utils/LocalStorage",["require","exports"],function(a,b){"use strict";function c(){var a="testLocalStorage",b="1";try{if(!window.localStorage)return!1;if(window.localStorage.setItem(a,b),window.localStorage.getItem(a)!==b)return!1}catch(c){return!1}return!0}function d(a){return void 0===a&&(a=e),c()?new h(a):new g(a)}var e="KindlePlayer",f={},g=function(){function a(a){this.namespace=a,f[a]||(f[a]={}),this.data=f[a]}return a.prototype.getItem=function(a){return this.data[a]},a.prototype.setItem=function(a,b){this.data[a]=b},a.prototype.removeItem=function(a){var b=this.data[a];return delete this.data[a],b},
a.prototype.clear=function(){this.data={},delete f[this.namespace]},a}();b.MemoryStorage=g;var h=function(){function a(a){this.namespace=a;var b=window.localStorage.getItem(a);this.data=b&&JSON.parse(b)||{}}return a.prototype.getItem=function(a){return this.data[a]},a.prototype.setItem=function(a,b){this.data[a]=b,window.localStorage.setItem(this.namespace,JSON.stringify(this.data))},a.prototype.removeItem=function(a){var b=this.data[a];return delete this.data[a],window.localStorage.setItem(this.namespace,JSON.stringify(this.data)),b},a.prototype.clear=function(){this.data={},window.localStorage.removeItem(this.namespace)},a}();b.LocalStorage=h,b.getStorage=d}),define("modules/metrics/UploadManager",["require","exports","modules/utils/Config","modules/utils/Service","modules/metrics/MetricsUtils","modules/metrics/PMET","modules/metrics/ReadingStreams","modules/utils/LocalStorage","modules/utils/DeviceUtils","jquery"],function(a,b,c,d,e,f,g,h,i,j){"use strict";function k(a){function b(){var a=o;return a+="uploadMetrics"}function c(){return{devicePlatform:a.devicePlatform,clientName:a.clientName,version:a.version,versionForCapability:a.versionForRS,versionForRS:a.versionForRS,messageNumber:a.messageNumber,sessionId:a.sessionId,metricBreakdown:a.breakdowns,metrics:a.metrics,readingStreamsMetrics:a.readingStreamsMetrics,marketplace:a.marketplace,pfm:a.pfm}}var e={Input:c(),Operation:"uploadMetricsExternal"},f=!a.isSync,g={url:b(),serviceCall:"uploadMetrics",postData:e,async:f};return console.debug("Uploading metrics:",e.Input),d.ajaxUnauthenticated(g).then(function(a){return a})}function l(a){function b(){x=!1,"hidden"!==document.visibilityState&&m()}if(!x){x=!0;var c=j.map(f.getBreakdownMap(),function(a,b){return b}),d=parseInt(u.getItem(v)||"0",10),e=j.map(t.getEvents(),function(a){return JSON.stringify(a)}),g=j.map(f.getMetrics(),function(a){return{method:a.reportedName,time:a.mainTimer.time,count:a.mainCounter.count,breakdown:c,properties:a.properties,counters:j.map(a.counters,function(a){return{name:a.name,count:a.count,breakdown:c}}),timers:j.map(a.timers,function(a){return delete a.started,a.breakdown=c,a})}});z.push.apply(z,e),y.push.apply(y,g),t.clearEvents(e.length),f.clearMetrics(g.length),z.length>0||y.length>0?(k({devicePlatform:p,clientName:q,marketplace:window.KindleGlobal.marketplace,pfm:window.KindleGlobal.pfm,breakdowns:f.getBreakdownMap(),version:r,versionForCapability:s,versionForRS:s,messageNumber:d,sessionId:window.KindleGlobal.requestInfo&&window.KindleGlobal.requestInfo.sId,metrics:y,readingStreamsMetrics:z,isSync:a}).then(function(){y=[],z=[]}).finally(b).catch(function(a){console.warn("Error occurred during uploadMetrics() attempt (will try again shortly):",a)}),u.setItem(v,(d+1).toString())):b()}}function m(){B&&clearTimeout(B),B=setTimeout(l,A)}function n(){function a(){var a=e.getCurrentContainerView();a&&(t.hideContext(a),f.record(f.createMetric("ClosedTab").appendToReportedName(a))),l(!0)}w||(w=!0,m(),document.addEventListener("visibilitychange",function(){var a=e.getCurrentContainerView();"hidden"===document.visibilityState?(a&&t.hideContext(a),l()):(a&&t.showContext(a),m())}),j(window).bind("unload",a),window.addEventListener("beforeunload",function(){j(window).unbind("unload",a),a()}))}var o=c.getUnauthenticatedBaseServiceUrl(),p=window.KindleGlobal.amazonDeviceType+":"+i.getDeviceCategory(),q=c.getMetricsProgram(),r=c.appConfig.version,s=c.appConfig.versionForRS,t=g.getManager(),u=h.getStorage(),v="messageNumber",w=!1,x=!1,y=[],z=[],A=2e3;b.uploadMetrics=l;var B;b.init=n}),define("modules/marketplace/Marketplace",["require","exports"],function(a,b){"use strict";var c=function(){function a(){this.USAmazon={marketplaceCode:"us"},this.CAAmazon={marketplaceCode:"ca"},this.BRAmazon={marketplaceCode:"br"},this.AUAmazon={marketplaceCode:"au"},this.MXAmazon={marketplaceCode:"mx"},this.GBAmazon={marketplaceCode:"uk"},this.DEAmazon={marketplaceCode:"de"},this.FRAmazon={marketplaceCode:"fr"},this.ITAmazon={marketplaceCode:"it"},this.ESAmazon={marketplaceCode:"es"},this.INAmazon={marketplaceCode:"in"},this.JPAmazon={marketplaceCode:"jp"},this.CNAmazon={marketplaceCode:"cn"},this.NLAmazon={marketplaceCode:"nl"},this.RUAmazon={marketplaceCode:"ru"}}return a}();b.AmazonMarketplaces=c;var d=new c;b.default=d}),define("modules/utils/ReadInKindle",["require","exports","modules/utils/DeviceUtils","modules/metrics/PMET","modules/metrics/ReadingStreams","modules/utils/RefTag","modules/utils/Utility","modules/utils/QueryParamUtils","modules/marketplace/Marketplace"],function(a,b,c,d,e,f,g,h,i){"use strict";function j(){var a=k();console.debug("Opening URL for RIK: "+a),c.isFBOpenLinkWorkaroundNeeded()?window.location.href=a:g.openInNewWindow(a)}function k(){var a,e=d.createMetric(b.metricsPrefix);return c.isAndroid()&&!c.isFireOS()&&q.marketplace!==i.default.CNAmazon.marketplaceCode?(d.record(e.appendToReportedName("Interstitial")),a=g.getReadUrl(q.appName+"-rik")):(d.record(e.appendToReportedName("PreAuth")),a=g.getReadUrl(q.appName+"-pre-auth"),c.isFireOS()&&(a=h.appendQueryParams(a,"fos=true")),c.isIOS()&&(a=a.replace(/^https/,"http"),a=h.updateQueryParams(a,{type:"EBSP",ref:"kindleplayer"}))),h.setSessionIdQueryParam(a)}function l(){if(c.isIOS()){var a=f.getEndpointRefTag(f.Constants.RIK_SUFFIX),b=g.getAppStoreUrlWithRefTag(window.KindleGlobal.appStoreUrl,a),d=window.KindleGlobal.openAppUrl;b&&d&&n(d,b)}}function m(a){var b=document.createElement("iframe");return b.style.display="none",document.body.appendChild(b),b.src=a,b}function n(a,c){var e=m(a),f=b.metricsPrefix+"::DeepLinking",g=d.createMetric(f);d.record(g.appendToReportedName(t)),p.recordMetadata(f,{status:t});var h=d.createMetric(f),i=Date.now();setTimeout(function(){Date.now()-i>r+s?(e.parentNode.removeChild(e),e=null,d.record(h.appendToReportedName(v)),p.recordMetadata(f,{status:v})):document.webkitHidden||document.hidden||(d.record(h.appendToReportedName(u)),p.recordMetadata(f,{status:u}),o(c))},r)}function o(a){console.debug("Opening URL for RIK: "+a),window.location.href=a}var p=e.getManager(),q=window.KindleGlobal,r=1e3,s=500;b.metricsPrefix="ReadInKindle";var t="DeepLinkingAttempted",u="OpenedFallback",v="TimeExceeded";b.trigger=j,b.performDeepLinkingIfPossible=l}),define("modules/ui/views/PreAuth",["require","exports","modules/errors/JqueryPromiseErrorHandler","modules/metrics/ReadingStreams","modules/metrics/MetricsUtils"],function(a,b,c,d,e){"use strict";return function(){function a(){var a=$("#kp-pre-auth-sign-in-button"),c=window.KindleGlobal.signinUrl;a.on("click",function(){e.recordPMET(b,"SignIn").always(function(){window.location.href=c})});var d=$("#kp-pre-auth-change-account-button"),f=window.KindleGlobal.forceSigninUrl;d.on("click",function(){e.recordPMET(b,"ChangeAccount").always(function(){window.location.href=f})})}var b="ReadInKindle::PreAuth";b+=window.KindleGlobal.requestInfo.auth?"::Authenticated":"::Unauthenticated",$(document).ready(function(){if("PreAuth"===window.KindleGlobal.page){var b=d.RSConstants.CONTEXT_PRE_AUTH;e.getManagers().then(function(a,c,d){d.setCurrentContainerView(b)},c.onPromiseRejected),e.recordShowContext(b),a()}})}()}),define("modules/ui/views/RIKDesktop",["require","exports","modules/utils/RefTag","modules/errors/JqueryPromiseErrorHandler","modules/utils/Service","modules/metrics/ReadingStreams","modules/metrics/MetricsUtils"],function(a,b,c,d,e,f,g){"use strict";return function(){function a(){e.requireWithRetry(["modules/utils/QueryParamUtils"],function(a){var d=$("#kp-rik-desktop-kcr-button"),e=c.getEndpointRefTag(c.Constants.RIK_DESKTOP_SUFFIX),h=c.getRefTagQueryParam(e),i=a.appendQueryParams(window.KindleGlobal.kcrv1Url,h);d.click(function(){window.location=i,g.recordActionAndUploadMetrics(b,f.RSConstants.ACTION_OPEN_KCR)})})}var b=f.RSConstants.CONTEXT_RIK_DESKTOP;$(document).ready(function(){"RIKDesktop"===window.KindleGlobal.page&&(g.getManagers().then(function(a,c,d){d.setCurrentContainerView(b)},d.onPromiseRejected),g.recordShowContext(b),a())})}()}),define("modules/ui/views/RikInterstitial",["require","exports","modules/errors/JqueryPromiseErrorHandler","modules/utils/Service","modules/metrics/ReadingStreams","modules/metrics/MetricsUtils"],function(a,b,c,d,e,f){"use strict";return function(){function a(){var a=$("#kp-rik-interstitial-open-app"),c=window.KindleGlobal.openAppUrl;a.on("click",function(){var a="OpenApp";d.requireWithRetry(["modules/utils/DeviceUtils"],function(c){f.recordPMET(b,a+"::"+c.getDevicePlatform())}),f.recordPMET(b,a).always(function(){window.location.href=c})});var e=$("#kp-rik-interstitial-install-app"),g=window.KindleGlobal.installAppUrl;e.on("click",function(){var a="InstallApp";d.requireWithRetry(["modules/utils/DeviceUtils"],function(c){f.recordPMET(b,a+"::"+c.getDevicePlatform())}),f.recordPMET(b,a).always(function(){window.location.href=g})})}var b="ReadInKindle::Interstitial";$(document).ready(function(){if("RIKInterstitial"===window.KindleGlobal.page){var g=e.RSConstants.CONTEXT_RIK_INTERSTITIAL;f.getManagers().then(function(a,b,c){c.setCurrentContainerView(g)},c.onPromiseRejected),f.recordShowContext(g),a(),d.requireWithRetry(["modules/utils/ReadInKindle"],function(a){a.performDeepLinkingIfPossible()}),d.requireWithRetry(["modules/utils/DeviceUtils"],function(a){f.recordPMET(b,a.getDevicePlatform())})}})}()}),define("modules/ui/views/UnsupportedBrowser",["require","exports","modules/errors/JqueryPromiseErrorHandler","modules/metrics/ReadingStreams","modules/metrics/MetricsUtils"],function(a,b,c,d,e){"use strict";return function(){function a(){f=[{domId:"#kp-download-chrome-button",downloadUrl:"https://www.google.com/chrome/browser/",metricName:d.RSConstants.ACTION_DOWNLOAD_CHROME_CLICKED},{domId:"#kp-download-firefox-button",downloadUrl:"https://www.mozilla.org/en-US/firefox/all/",metricName:d.RSConstants.ACTION_DOWNLOAD_FIREFOX_CLICKED},{domId:"#kp-download-safari-button",downloadUrl:"https://support.apple.com/downloads/safari",metricName:d.RSConstants.ACTION_DOWNLOAD_SAFARI_CLICKED},{domId:"#kp-download-ie-button",downloadUrl:"http://windows.microsoft.com/en-us/internet-explorer/download-ie",metricName:d.RSConstants.ACTION_DOWNLOAD_IE_CLICKED}],f.forEach(b)}function b(a){$(a.domId).on("click",function(){e.recordActionAndUploadMetrics(a.metricName,d.RSConstants.CONTEXT_UNSUPPORTED_BROWSER).always(function(){window.open(a.downloadUrl,"_blank")})})}var f;$(document).ready(function(){if("UnsupportedBrowser"===window.KindleGlobal.page){var b=d.RSConstants.CONTEXT_UNSUPPORTED_BROWSER;e.getManagers().then(function(a,c,d){d.setCurrentContainerView(b)},c.onPromiseRejected),e.recordShowContext(b),a()}})}()}),define("modules/ui/widgets/KindleAppDownload",["require","exports","modules/metrics/ReadingStreams","modules/metrics/MetricsUtils","modules/utils/RefTag","modules/utils/Utility","modules/utils/DeviceUtils"],function(a,b,c,d,e,f,g){"use strict";function h(a,b){b.find("#kp-get-kindle-app-button, #kp-get-kindle-app-link").click(function(){d.recordActionAndUploadMetrics(a,c.RSConstants.ACTION_GET_KINDLE_APP_CLICKED),i()})}function i(){var a=e.getEndpointRefTag(e.Constants.GET_APP_END_ACTION_SUFFIX),b=f.getAppStoreUrlWithRefTag(window.KindleGlobal.appStoreUrl,a);g.shouldSimulateClickForITunes()?f.simulateClickForLink(b):f.openInNewWindow(b)}b.initialize=h}),define("modules/ui/views/PDocQuoteShareLandingPageView",["require","exports","modules/ui/widgets/KindleAppDownload","modules/metrics/ReadingStreams","modules/metrics/MetricsUtils"],function(a,b,c,d,e){"use strict";return function(){function a(a){a.find(".kp-conditions-of-use").click(function(){e.recordAction(f,d.RSConstants.ACTION_CONDITIONS_OF_USE_CLICKED)}),a.find(".kp-privacy-notice").click(function(){e.recordAction(f,d.RSConstants.ACTION_PRIVACY_NOTICE_CLICKED)}),a.find(".kp-legal-notices").click(function(){e.recordAction(f,d.RSConstants.ACTION_LEGAL_NOTICES_CLICKED)})}function b(b){g=b,a(g)}var f=d.RSConstants.CONTEXT_PDOC_SHARE_PAGE;c.initialize(f,$("#kp-pdoc-get-kindle-app"));var g;return{initLegalFooter:a,initialize:b}}()});var __extends=this&&this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);a.prototype=null===b?Object.create(b):(c.prototype=b.prototype,new c)};define("modules/notebook/Clipboard",["require","exports","handlebars","modules/utils/DeviceUtils","modules/metrics/MetricsUtils","modules/metrics/ReadingStreams"],function(a,b,c,d,e,f){"use strict";var g;!function(a){a[a.Highlight=1]="Highlight",a[a.Note=2]="Note",a[a.ChildNote=3]="ChildNote",a[a.Metadata=4]="Metadata"}(g||(g={}));var h=function(){function a(a,b){var c=this;this.text=a,this.type=b,this.isHighlight=function(){return c.is(g.Highlight)},this.isNote=function(){return c.is(g.Note)||c.is(g.ChildNote)},this.isChildNote=function(){return c.is(g.ChildNote)},this.isMetadata=function(){return c.is(g.Metadata)},this.text=a,this.type=b}return a.prototype.is=function(a){return this.type===a},a}(),i=function(a){function b(b,c){var d=this;a.call(this,b,g.Metadata),this.starred=c,this.isStarred=function(){return d.starred},this.starred=c,this.text=this.text.replace(/\n/g," "),this.text=this.text.replace(/\s+/g," ")}return __extends(b,a),b}(h),j=function(a){function b(b,c){void 0===c&&(c=[]),a.call(this,b,g.Highlight),this.notes=c,this.text=b,this.notes=c}return __extends(b,a),b}(h),k=function(a){function b(b,c,d){var e=this;void 0===c&&(c=!1),void 0===d&&(d=!1),a.call(this,b,d?g.ChildNote:g.Note),this.starred=c,this.isStarred=function(){return e.starred},this.starred=c}return __extends(b,a),b}(h),l={txtTemplate:"ClipboardText",htmlTemplate:"ClipboardHtml",noteClass:"kp-notebook-note",highlightClass:"kp-notebook-highlight",metadataClass:"kp-notebook-metadata",starredSelector:".kp-notebook-starred,.kp-notebook-note-starred",copyableSelector:".kp-notebook-selectable:not(.aok-hidden):not(.kp-notebook-starred):not(.kp-notebook-note-starred):not(#note-label)"},m=function(){function a(){var a=this;this.CopyHandler=function(b){var c=b.originalEvent;if(a.isNotNull(document.getSelection())){var g=document.getSelection(),h=a.associateNotesToHighlights(a.extractCopyableObjectsFromSelection(g));if(h.length>0){var i=$(a.renderHandlebarToJQuery(h,l.htmlTemplate)),j=a.renderHandlebarToJQuery(h,l.txtTemplate),k=i.get(0).outerHTML;a.isWindows()&&(j=j.replace(/\n/g,"\r\n"));var m=window;m.clipboardData?m.clipboardData.setData("Text",j):(c.clipboardData.setData("text/html",k),c.clipboardData.setData("text/plain",j)),d.isIOS()||c.preventDefault();for(var n=0,o=0,p=0,q=h;p<q.length;p++){var r=q[p];r.isHighlight()?n++:(r.isNote()||r.isChildNote())&&o++}e.recordAction(f.RSConstants.CONTEXT_NOTEBOOK_PAGE,f.RSConstants.ACTION_HIGHLIGHTS_NOTES_COPY,{CopyableItemsCount:h.length,CopyableHighlightCount:n,CopyableNoteCount:o})}}}}return a.prototype.isWindows=function(){return"Windows"===window.KindleGlobal.deviceInfo.osFamily},a.prototype.createCopyable=function(a,b){var c=null;if(this.isNotNull(a)){var d=null;d=a.parentElement?a.nodeType===Node.ELEMENT_NODE?a:a.parentElement:a.nodeType===Node.ELEMENT_NODE?a:a.parentNode;var e="."+l.highlightClass+",."+l.noteClass+",."+l.metadataClass,f=$(d).parents().add(d).filter(e).first().get(0);if(this.isNotNull(f))if(f.classList.contains(l.highlightClass))c=new j(b,new Array);else if(f.classList.contains(l.noteClass)){var g=$(f).siblings("."+l.highlightClass).first().get(0);if(this.isNotNull(g)){var h=$(f).children(l.starredSelector).first().get(0);c=this.isNotNull(h)?new k(b,!0,!0):new k(b,!1,!0)}else c=new k(b)}else if(f.classList.contains(l.metadataClass)){var m=!1,g=$(f).siblings(l.starredSelector).first().get(0);this.isNotNull(g)&&(m=!0),c=new i(b,m)}}return c},a.prototype.isNull=function(a){return void 0===a||null===a},a.prototype.isNotNull=function(a){return!this.isNull(a)},a.prototype.extractCopyableObjectsFromSelection=function(a){for(var b=[],c=0;c<a.rangeCount;c++){var d=a.getRangeAt(c);if(!this.isNull(d.startContainer)&&!this.isNull(d.endContainer))if(d.startContainer!==d.endContainer||d.startContainer.nodeType!==Node.TEXT_NODE){var e=null,f=null;if(d.startContainer.nodeType===Node.TEXT_NODE){var g=d.startContainer,h=d.startOffset,i=g.textContent.substring(h);e=this.createCopyable(g,i)}if(d.endContainer.nodeType===Node.TEXT_NODE){var j=d.endContainer,k=d.endOffset,i=j.textContent.substring(0,k);f=this.createCopyable(j,i)}for(var m=d.cloneContents(),n=m.querySelectorAll(""+l.copyableSelector),o=[],p=0;p<n.length;p++){var q=n.item(p),i=q.textContent;if(i.length>0){var r=this.createCopyable(q,i);this.isNotNull(r)&&o.push(r)}}for(var s=0,t=o;s<t.length;s++){var u=t[s];b.push(u)}b.length>0&&(this.isNotNull(e)&&(b[0].text=e.text),this.isNotNull(f)&&(b[b.length-1].text=f.text))}else{var i=d.startContainer.textContent.substring(d.startOffset,d.endOffset),v=this.createCopyable(d.startContainer,i);this.isNotNull(v)&&b.push(v)}}return b},a.prototype.renderHandlebarToJQuery=function(a,b){var d={objects:a};return c.templates[b](d)},a.prototype.associateNotesToHighlights=function(a){if(this.isNull(a))return null;if(a.length<2)return a.slice();for(var b=new Array,c=null,d=0;d<a.length;d++){var e=a[d];e.isHighlight()?(c=e,b.push(c)):e.isChildNote()&&this.isNotNull(c)?c.notes.push(e):b.push(e)}return b},a}();b.NotebookClipboardHandlers=m}),define("modules/metrics/CSM",["require","exports"],function(a,b){"use strict";function c(a){window.ue&&window.ue.tag(a)}function d(){g(window.uet,"cf",h)}function e(){g(window.uet,"bb",h)}function f(){g(window.uex,"ld",h)}function g(a,b,c){"function"==typeof a&&a(b,c,{wb:1})}var h="KindlePlayerCriticalFeature";b.registerTag=c,b.logCriticalFeatureMarker=d,b.logBodyBeginMarker=e,b.uploadCSM=f}),define("modules/notebook/SearchCore",["require","exports"],function(a,b){"use strict";var c=function(){function a(){this.searchIndex={}}return a.prototype.appendToSearchIndex=function(a,b){this.searchIndex[a]=this.normalize(b)},a.prototype.search=function(a){var b=[],c=this.determineSearchStrings(a);for(var d in this.searchIndex)this.containAllSearchTerms(this.searchIndex[d],c)&&b.push(d);return b},a.prototype.containAllSearchTerms=function(a,b){for(var c=0;c<b.length;++c)if(!this.aContainsB(a,b[c]))return!1;return!0},a.prototype.determineSearchStrings=function(a){return this.normalize(a).split(/\s/g)},a.prototype.normalize=function(a){return void 0===typeof a?"":a.trim().toLocaleLowerCase()},a.prototype.aContainsB=function(a,b){return a.indexOf(b)>=0},a}();b.SearchEngine=c}),define("modules/notebook/Search",["require","exports","modules/notebook/SearchCore","modules/metrics/ReadingStreams","modules/metrics/MetricsUtils"],function(a,b,c,d,e){"use strict";function f(a){$(y).submit(function(){return u=Date.now(),v=[],e.recordAction(d.RSConstants.CONTEXT_NOTEBOOK_PAGE,d.RSConstants.ACTION_NOTEBOOK_SEARCH_SUBMITTED),k(window.KindleGlobal.deviceInfo.deviceType!==x),window.KindleGlobal.deviceInfo.deviceType!==w&&$(z).blur(),!1}),r=null!==a&&void 0!==a?a:function(){}}function g(a){t=a}function h(){return t}function i(){var a=new c.SearchEngine;$(".kp-notebook-library-each-book").each(function(){var b=$(this),c=b.attr("id"),d="";b.find(".kp-notebook-searchable").each(function(){d+=" "+$(this).text()}),a.appendToSearchIndex(c,d)}),s=a}function j(){if(p(),$("#kp-notebook-library-no-results").addClass("aok-hidden"),window.KindleGlobal.deviceInfo.deviceType!==x){var a=$(".a-row .kp-notebook-library-each-book")[0].id;r(a)}}function k(a){var b=m(),c=s.search(b),d=$(".a-row .kp-notebook-library-each-book").length;o(b,c),0===c.length&&t&&0!==d?($("#kp-notebook-library-no-results").removeClass("aok-hidden"),n(b)):($("#kp-notebook-library-no-results").addClass("aok-hidden"),d!==c.length&&0!==c.length&&l(c)),0===c.length&&window.KindleGlobal.deviceInfo.deviceType===w&&null!==r&&void 0!==r?r(""):a&&""!==b&&c[0]!==$("#kp-notebook-annotations-asin").val()&&r(c[0])}function l(a){var b=[];a.forEach(function(a){-1===v.indexOf(a)&&b.push(a)});var c={numberOfResultsFound:b.length,searchTimeInMilliseconds:Date.now()-u,hasLibraryFullyLoaded:t};b.length>0&&(e.recordAction(d.RSConstants.CONTEXT_NOTEBOOK_PAGE,d.RSConstants.ACTION_NOTEBOOK_SEARCH_RESULTS_FOUND,c,Date.now()),v.push.apply(v,b))}function m(){return void 0===$("#kp-notebook-search-input").val()?"":$("#kp-notebook-search-input").val().trim()}function n(a){var b="#kp-notebook-search-no-results-text",c="kp-notebook-search-string";-1!==$(b).text().indexOf("{0}")&&$(b).html($(b).text().replace("{0}","<strong class='"+c+"'></strong>")),$(b).find("."+c).text(a)}function o(a,b){""===a?p():q(b)}function p(){$(".kp-notebook-library-each-book").removeClass("aok-hidden")}function q(a){$(".kp-notebook-library-each-book").each(function(){var b=$(this),c=b.attr("id");-1===$.inArray(c,a)?b.addClass("aok-hidden"):b.removeClass("aok-hidden")})}var r,s=new c.SearchEngine,t=!1,u=Date.now(),v=[],w="Desktop",x="Mobile",y="#kp-notebook-search-form",z="#kp-notebook-search-input";b.attachHandlers=f,b.setLibraryLoadCompleted=g,b.getLibraryLoadCompleted=h,b.buildSearchIndex=i,b.setNotebookViewToInitialState=j,b.updateNotebookView=k}),define("modules/utils/csrf",["require","exports"],function(a,b){"use strict";var c="CSRF Token not present in the DOM.",d="CSRF Header could not be added to AJAX request.";b.getCsrfToken=function(){var a=document.querySelector('input[name="anti-csrftoken-a2z"]');if(!a||!a.getAttribute("value"))throw new TypeError(c);return a.getAttribute("value")},b.addCsrfHeader=function(a,e){void 0===e&&(e=!1);var f=a;try{f["anti-csrftoken-a2z"]=b.getCsrfToken()}catch(g){if("TypeError"!==g.name||g.message!==c)throw g;if(e)throw new TypeError(d);console.error(d)}return f}}),define("modules/ui/views/NotebookView",["require","exports","modules/utils/QueryParamUtils","modules/utils/RefTag","modules/utils/DeviceUtils","modules/utils/StringUtils","modules/notebook/Clipboard","modules/metrics/ReadingStreams","modules/metrics/MetricsUtils","modules/metrics/PMET","modules/metrics/CSM","modules/notebook/Search","modules/utils/csrf"],function(a,b,c,d,e,f,g,h,i,j,k,l,m){"use strict";return function(){function a(a,d,e,k,o){function p(a){var b=document.createElement("iframe");return b.style.display="none",document.body.appendChild(b),b.src=a,b}function q(b){for(var c=b.split("-")[1],d=document.getElementById(c),e=u(d),f=a.$("<ul class='a-unordered-list a-nostyle a-vertical'></ul>"),g=0;g<e.length;g++){e[g].appendTo(f)}var h=document.getElementById(b+"-action"),i=a.$;o.get(i(h)).update({$trigger:i(h),content:f})}function t(a){switch(a){case N:return G;case O:return z;case P:return x;case Q:return y;case R:return B}}function u(b){var c=a.$(b).find(".kp-notebook-highlight"),d=a.$(b).find("#note"),e=c.length>0&&!c.hasClass("aok-hidden"),f=d.length>0&&d.text().length>0,g=new Array,h=a.$(b).attr("id");return window.KindleGlobal.deviceInfo.deviceType===L&&g.push(v(N,"KP_YNH_OPTIONS_DD_READMORE",h)),e&&f?g.push(v(P,"KP_YNH_OPTIONS_DD_EDIT_NOTE",h),v(R,"KP_YNH_OPTIONS_DD_DELETE_HIGHLIGHT",h),v(Q,"KP_YNH_OPTIONS_DD_DELETE_NOTE",h)):e?g.push(v(O,"KP_YNH_OPTIONS_DD_ADD_NOTE",h),v(R,"KP_YNH_OPTIONS_DD_DELETE_HIGHLIGHT",h)):f&&g.push(v(P,"KP_YNH_OPTIONS_DD_EDIT_NOTE",h),v(Q,"KP_YNH_OPTIONS_DD_DELETE_NOTE",h)),g}function v(b,c,d){var e=window.KindleGlobal.localizedStrings[c],f=a.$("<li class='a-spacing-small'><span class='a-list-item'><a class='a-link-normal' href='javascript:void(0);' id='"+b+"' value='"+d+"'>"+e+"</a></span></span></li>");return f.find("a").bind("click",t(b)),f}function w(){var b=a.$("#editNoteDiv");b.hasClass("aok-hidden")||b.prev().removeClass("aok-hidden");var c=a.$("#addNoteDiv");a.$(b).addClass("aok-hidden"),a.$(c).addClass("aok-hidden")}function x(){var c=$(this).attr("value"),d=a.$("#editNoteDiv");w(),T(c);var e=document.getElementById(c),g=F(e),h=document.getElementById(g);a.$(d).insertAfter(h),a.$("#editNoteAnnotationId").val(c),a.$("#editNoteError").addClass("aok-hidden"),d.removeClass("aok-hidden"),a.$(h).addClass("aok-hidden");var i=a.$("textarea#editNoteTextArea");i.val(f.unescapeAndFormatHTML(a.$(h).find("#note").html())),i.removeClass("kp-notebook-textarea-error"),b(i)}function y(){var b=$(this).attr("value");a.$("#deleteNoteAnnotationId").val(b),w(),window.KindleGlobal.deviceInfo.deviceType===K&&d.get(a.$("#deleteNoteModal")).attrs("width","300"),a.$("#deleteNoteError").addClass("aok-hidden"),d.get(a.$("#deleteNoteModal")).show()}function z(){var c=$(this).attr("value"),d=a.$("#addNoteDiv");T(c),w();var e=document.getElementById(c),f=D(e),g=document.getElementById(f);a.$(d).insertAfter(g),a.$("#addNoteAnnotationId").val(c),a.$("#addNoteTextArea").val(""),a.$("#addNoteError").addClass("aok-hidden"),a.$(d).removeClass("aok-hidden");var h=a.$("#addNoteTextArea");h.removeClass("kp-notebook-textarea-error"),b(h)}function B(){var b=$(this).attr("value");a.$("#deleteHighlightAnnotationId").val(b),w(),window.KindleGlobal.deviceInfo.deviceType===K&&d.get(a.$("#deleteHighlightModal")).attrs("width","300"),a.$("#deleteHighlightError").addClass("aok-hidden"),d.get(a.$("#deleteHighlightModal")).show()}function C(b){a.$("#addNoteDiv").insertAfter(b).addClass("aok-hidden"),a.$("#editNoteDiv").insertAfter(b).addClass("aok-hidden")}function D(b){return a.$(b).find(".kp-notebook-highlight").attr("id")}function F(b){return a.$(b).find(".kp-notebook-note").attr("id")}function G(){var a=$(this).attr("value");T(a),H(I,a),i.recordAction(S,h.RSConstants.ACTION_OPEN_IN_KINDLE_TRIGGER)}function H(b,e){var f={},g=document.getElementById(e);f.asin=b,f.location=a.$(g).find("#kp-annotation-location").val();var j=c.appendQueryParamsMap(window.KindleGlobal.openAppUrl,f),k=p(j),l=function(){k&&(k.parentNode.removeChild(k),k=null)},m=setTimeout(function(){a.$(window).unbind("blur",n),l(),d.get(a.$("#readMoreModal")).show(),i.recordAction(S,h.RSConstants.ACTION_OPEN_IN_KINDLE_FAIL)},M),n=function(){clearTimeout(m),a.$(window).unbind("blur",n),l(),i.recordAction(S,h.RSConstants.ACTION_OPEN_IN_KINDLE_SUCCESS)};a.$(window).bind("blur",n)}function T(b){o.get(a.$(document.getElementById("popover-"+b+"-action"))).hide()}var U=new g.NotebookClipboardHandlers;a.$(document.documentElement).bind("copy",U.CopyHandler),a.declarative("get-annotations-for-asin","click",function(a){s(a.data.asin)}),a.declarative("back","click",function(){a.$("#kp-notebook-annotations-pane").addClass("aok-hidden"),a.$("#header").addClass("aok-hidden"),a.$("#library").show()}),a.on("a:dropdown:select",function(a){"kp-notebook-library-sortOrder"===a.name&&n(a)}),a.on("a:popover:beforeShow:optionsPopover",function(a){q(a.popover.$trigger.find("a").attr("id"))}),a.on("a:popover:afterShow:optionsPopover",function(b){var c=b.popover.$trigger.find("a").attr("id"),d=document.getElementById(c+"-action");$("#annotation-scroller").unbind("scroll.my-popover-scroll-unique-name").bind("scroll.my-popover-scroll-unique-name",function(){var b=a.$;o.get(b(d)).hide()})}),a.declarative("edit-note-action","click",function(){var b=a.$("#editNoteAnnotationId").val(),c=a.$("#editNoteTextArea").val();if(J.test(c)){var d=k(document.getElementById("editNoteText"));d.disable();var e=document.getElementById(b),g=F(e),j=document.getElementById(g),l=a.$("#editNoteDiv");a.$("#editNoteError").addClass("aok-hidden"),g=g.split("-")[1];var n=[];m.addCsrfHeader(n),a.$.ajax({url:r("note"),type:"POST",contentType:"application/x-www-form-urlencoded; charset=UTF-8",headers:n,data:{noteId:g,noteText:c},success:function(b){if(b.result){var d=f.escapeAndFormatHTML(c);a.$(j).find("#note").html(d),l.addClass("aok-hidden"),a.$(j).removeClass("aok-hidden"),i.recordAction(S,h.RSConstants.ACTION_NOTE_EDITED)}else a.$("#editNoteError").removeClass("aok-hidden"),i.recordAction(h.RSConstants.CONTEXT_ERROR_ALERT,h.RSConstants.ACTION_NOTE_EDITED)},error:function(){a.$("#editNoteError").removeClass("aok-hidden"),i.recordAction(h.RSConstants.CONTEXT_ERROR_ALERT,h.RSConstants.ACTION_NOTE_EDITED)},complete:function(){d.enable()}})}else a.$("#editNoteTextArea").addClass("kp-notebook-textarea-error")}),a.declarative("cancel-edit-note-action","click",function(){var b=a.$("#editNoteAnnotationId").val(),c=a.$("#editNoteDiv"),d=document.getElementById(b),e=F(d),f=document.getElementById(e);c.addClass("aok-hidden"),a.$(f).removeClass("aok-hidden"),a.$("#editNoteTextArea").val("").removeClass("kp-notebook-textarea-error")}),$("#kp-notebook-search-input").keyup(function(){$("#kp-notebook-search-input").val().length<1?$("#kp-notebook-search-clear").addClass("aok-hidden"):$("#kp-notebook-search-clear").removeClass("aok-hidden")}),a.declarative("delete-note-action","click",function(){var b=k("#deleteNote");b.disable();var e={},f=a.$("#deleteNoteAnnotationId").val(),g=document.getElementById(f),j=F(g),l=document.getElementById(j);j=j.split("-")[1],e.noteId=j,a.$("#deleteNoteError").addClass("aok-hidden");var n=[];m.addCsrfHeader(n),a.$.ajax({url:c.appendQueryParamsMap(r("note"),e),headers:n,type:"DELETE",success:function(b){if(b.result){C(g);var c=a.$(g).find(".kp-notebook-highlight");0===c.length||c.hasClass("aok-hidden")?a.$(g).remove():(a.$(l).find("#note").text(""),a.$(l).addClass("aok-hidden").attr("id","note-")),A(),d.get(a.$("#deleteNoteModal")).hide(),i.recordAction(S,h.RSConstants.ACTION_NOTE_DELETED)}else a.$("#deleteNoteError").removeClass("aok-hidden"),i.recordAction(h.RSConstants.CONTEXT_ERROR_ALERT,h.RSConstants.ACTION_NOTE_DELETED)},error:function(){a.$("#deleteNoteError").removeClass("aok-hidden"),i.recordAction(h.RSConstants.CONTEXT_ERROR_ALERT,h.RSConstants.ACTION_NOTE_DELETED)},complete:function(){b.enable()}})}),a.declarative("add-note-action","click",function(){var b=a.$("#addNoteTextArea").val();if(J.test(b)){var c=k(document.getElementById("addNoteText"));c.disable();var d=a.$("#addNoteAnnotationId").val(),e=document.getElementById(d),g=a.$("#addNoteDiv"),j={};j.highlightId=d,j.noteText=b,a.$("#addNoteError").addClass("aok-hidden");var l=[];m.addCsrfHeader(l),a.$.ajax({url:r("note"),data:{highlightId:d,noteText:b},headers:l,contentType:"application/x-www-form-urlencoded; charset=UTF-8",type:"POST",success:function(c){var d=c.noteId;a.$(e).find("#note-").attr("id","note-"+d);var j=document.getElementById("note-"+d),k=f.escapeAndFormatHTML(b);a.$(j).find("#note").html(k),a.$(j).removeClass("aok-hidden"),a.$(g).addClass("aok-hidden"),A(),i.recordAction(S,h.RSConstants.ACTION_NOTE_ADDED)},error:function(){a.$("#addNoteError").removeClass("aok-hidden"),i.recordAction(h.RSConstants.CONTEXT_ERROR_ALERT,h.RSConstants.ACTION_NOTE_ADDED)},complete:function(){c.enable()}})}else a.$("#addNoteTextArea").addClass("kp-notebook-textarea-error")}),a.declarative("cancel-add-note-action","click",function(){a.$("#addNoteDiv").addClass("aok-hidden"),a.$("#addNoteTextArea").val("").removeClass("kp-notebook-textarea-error")}),a.declarative("clear-search-field","click",function(){$("#kp-notebook-search-input").val(""),$("#kp-notebook-search-clear").addClass("aok-hidden"),l.buildSearchIndex(),l.setNotebookViewToInitialState()}),a.declarative("delete-highlight-action","click",function(){var b=k("#deleteHighlight");b.disable();var e={},f=a.$("#deleteHighlightAnnotationId").val(),g=document.getElementById(f),j=D(g),l=document.getElementById(j),n=F(g),o=document.getElementById(n);j=j.split("-")[1],e.highlightId=j,a.$("#deleteHighlightError").addClass("aok-hidden");var p=[];m.addCsrfHeader(p),a.$.ajax({url:c.appendQueryParamsMap(r("highlight"),e),headers:p,type:"DELETE",success:function(b){b.result?(C(g),""===a.$(l).next().find("#note").text()?a.$(g).remove():(a.$(l).find("#highlight").text(""),a.$(l).addClass("aok-hidden"),a.$(g).find("#note-label").text(""),a.$(g).find("#annotationHighlightHeader").addClass("aok-hidden"),a.$(g).find("#annotationNoteHeader").removeClass("aok-hidden"),a.$(o).removeClass("a-spacing-top-base")),A(),d.get(a.$("#deleteHighlightModal")).hide(),i.recordAction(S,h.RSConstants.ACTION_HIGHLIGHT_DELETED)):(a.$("#deleteHighlightError").removeClass("aok-hidden"),
i.recordAction(h.RSConstants.CONTEXT_ERROR_ALERT,h.RSConstants.ACTION_HIGHLIGHT_DELETED))},error:function(){a.$("#deleteHighlightError").removeClass("aok-hidden"),i.recordAction(h.RSConstants.CONTEXT_ERROR_ALERT,h.RSConstants.ACTION_HIGHLIGHT_DELETED)},complete:function(){b.enable(),E()}})}),a.declarative("kp-notebook-detail-page-url","click",function(){i.recordAction(S,h.RSConstants.ACTION_DETAIL_PAGE_CLICKED)});var V=j.getMetric(j.Constants.NOTEBOOK_PAGE_LOADED);j.record(V.stopTimer())}function b(a){setTimeout(function(){$(a).focus()},600)}function n(a){var b=window.location.href,d=c.updateQueryParams(b,{sort:a.value});window.location.href=d}function o(a){$(".a-color-base-background").removeClass("a-color-base-background"),$("#"+a).addClass("a-color-base-background")}function p(){return window.location.origin+window.location.pathname}function q(a){return["stagingKey"].forEach(function(b){var d=c.getQueryParameter(b);void 0!==d&&""!==d&&(a[b]=d)}),a}function r(a){return p()+"/"+("note"===a?"note":"highlight")+window.location.search}function s(a){if(j.createMetric(j.Constants.NOTEBOOK_PAGE_ANNOTATIONS_LOADED).startTimer(),"Mobile"===window.KindleGlobal.deviceInfo.deviceType?($("#library").hide(),$("#header").removeClass("aok-hidden")):o(a),$("#kp-notebook-annotations-pane").addClass("aok-hidden"),$("#kp-notebook-annotations-pane").html(""),""!==a){$("#kp-notebook-spinner").show();var b={};b.asin=a,b.contentLimitState="",$.get(c.appendQueryParamsMap(p(),q(b)),function(b){$("#kp-notebook-annotations-pane").html(b),void 0!==$("#kp-notebook-check-validity")?($("#kp-notebook-annotations-pane").removeClass("aok-hidden"),$("#kp-notebook-spinner").hide(),$(".kp-notebook-library-each-book:not(.aok-hidden)").length,I=a,v(a)):window.location.reload()}).fail(function(a){0===a.status&&window.location.reload()})}}function t(){var a=$($(".kp-notebook-annotations-next-page-start").get(0)).val();u(0,I,a)}function u(a,b,d){if(void 0!==d&&""!==d){a++;var e={};e.asin=b,e.token=d,e.contentLimitState=$(".kp-notebook-content-limit-state").last().val(),$.get(c.appendQueryParamsMap(p(),q(e)),function(c){b===I&&($("#kp-notebook-annotations").append(c),d=$($(".kp-notebook-annotations-next-page-start").get(a)).val(),u(a,b,d))}).fail(function(){$("#kp-notebook-annotations-load-error").removeClass("aok-hidden"),i.recordAction(S,h.RSConstants.ACTION_NOTEBOOK_PAGE_ANNOTATIONS_LOAD_FAIL)})}else{$("#kp-notebook-annotations-spinner").hide(),A(),E();var f=j.getMetric(j.Constants.NOTEBOOK_PAGE_ANNOTATIONS_LOADED);f&&j.record(f.stopTimer())}}function v(a){if(""===a&&0!==$("a-row kp-notebook-library-each-book").length)return void $("#kp-notebook-annotations-pane").html("");var b=$("#kp-notebook-annotated-date-"+a).val();$("#kp-notebook-annotated-date").text(b),z(),t()}function w(){0===$(".kp-notebook-library-each-book").length&&i.recordViewShown(h.RSConstants.CONTEXT_NOTEBOOK_PAGE_EMPTY_LIB),x(0,$($(".kp-notebook-library-next-page-start").get(0)).val())}function x(a,b){if(void 0!==b&&""!==b){a++;var d={};d.library="list",d.token=b,$.get(c.appendQueryParamsMap(p(),q(d)),function(c){var d=y(c);$("#kp-notebook-library").append(d),b=$($(".kp-notebook-library-next-page-start").get(a)).val(),x(a,b)}).fail(function(){$("#kp-notebook-library-load-error").removeClass("aok-hidden"),i.recordAction(S,h.RSConstants.ACTION_NOTEBOOK_PAGE_LIBRARY_LOAD_FAIL)})}else{$("#kp-notebook-library-spinner").hide();var e=j.getMetric(j.Constants.NOTEBOOK_PAGE_LIBRARY_LOADED);e&&j.record(e.stopTimer()),l.setLibraryLoadCompleted(!0)}l.buildSearchIndex(),l.updateNotebookView(window.KindleGlobal.deviceInfo.deviceType!==K)}function y(a){var b=$("<div>"+a+"</div>"),c=[];$("#kp-notebook-library div.kp-notebook-library-each-book").each(function(a,b){c.push(b.id)});var d=[];b.find("div.kp-notebook-library-each-book").each(function(a,b){d.push(b.id)});for(var e=0;e<d.length;e++){var f=d[e];c.indexOf(f)>=0&&b.find("div#"+f).remove()}return b.children()}function z(){$("#annotation-section").css("margin-bottom","0px"),$("#library-section").css("margin-bottom","0px"),$("#annotation-section").height(e.getWindowHeight()-$("#kp-notebook-head").outerHeight(!0)),$("#library-section").height(e.getWindowHeight()-$("#kp-notebook-head").outerHeight(!0)-$("#books-filter").outerHeight(!0)-$("#kp-notebook-search-row").outerHeight(!0))}function A(){var a=$(".kp-notebook-highlight:not(.aok-hidden)").length,b=$(".kp-notebook-note:not(.aok-hidden)").length,c=$(".a-row .kp-notebook-library-each-book").length;0===a&&0===b&&0===c&&($("#empty-annotations-pane").removeClass("aok-hidden"),$("#kp-notebook-search-input").addClass("a-form-disabled"),$("#kp-notebook-search-input").attr("disabled","disabled"),$("#kp-notebook-search-button").addClass("a-button-disabled"),$("#kp-notebook-search-button").attr("disabled","disabled"),i.recordViewShown(h.RSConstants.CONTEXT_NOTEBOOK_PAGE_EMPTY_ANNOTATIONS)),""!==I?($("#kp-notebook-highlights-count").text(a),$("#kp-notebook-notes-count").text(b)):($("#kp-notebook-highlights-count").text("--"),$("#kp-notebook-notes-count").text("--"))}function B(){return $(".kp-notebook-highlight-truncated").length}function C(){return $(".kp-notebook-highlight-hidden").length}function D(){return $(".kp-notebook-highlight-empty-text").length}function E(){B()>0||C()>0?$("#kp-notebook-hidden-annotations-summary").removeClass("aok-hidden"):$("#kp-notebook-hidden-annotations-summary").addClass("aok-hidden"),F()}function F(){var a=$("#kp-notebook-annotations-asin").val();G(h.RSConstants.ACTION_HIGHLIGHT_TRUNCATED,B(),a),G(h.RSConstants.ACTION_HIGHLIGHT_HIDDEN,C(),a),G(h.RSConstants.ACTION_HIGHLIGHT_EMPTY_TEXT,D(),a)}function G(a,b,c){b>0&&i.recordAction(S,a,{asin:c,count:b})}function H(){window.KindleGlobal.deviceInfo.deviceType===K&&($("#kp-notebook-search-input").focus(function(){$("#kp-notebook-head").css("position","absolute")}),$("#kp-notebook-search-input").blur(function(){$("#kp-notebook-head").css("position","fixed")}),$("#library-section-mobile").on("touchstart",function(){$("#kp-notebook-head").css("position","fixed")}))}var I,J=/\S/,K="Mobile",L="Desktop",M=1500,N="readmore",O="addnote",P="editnote",Q="deletenote",R="deletehighlight",S=h.RSConstants.CONTEXT_NOTEBOOK_PAGE;return $(document).ready(function(){i.recordViewShown(S),d.removeRefTagFromUrl(d.Constants.K4W_KA_NOTEBOOK),I=$("#kp-notebook-annotations-asin").val(),o(I),k.logCriticalFeatureMarker(),v(I),w(),H(),$("#kp-notebook-head-placeholder").height($("#kp-notebook-head").outerHeight(!0)),window.onresize=function(){z()},l.attachHandlers(function(a){s(a)})}),{initialize:a}}()});